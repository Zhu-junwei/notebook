##   ğŸ“Œ ç¼–è¯‘ä¸€ä¸ªå®‰å“ ROM çš„åŸºæœ¬æµç¨‹

### 1. ç¯å¢ƒå‡†å¤‡

åœ¨ Linux ç³»ç»Ÿä¸‹æ“ä½œæœ€æ–¹ä¾¿ï¼ˆæ¨è Ubuntu/Debianï¼‰ã€‚
 éœ€è¦å®‰è£…ï¼š

- `openjdk-11` æˆ– `openjdk-17`
- `repo` å·¥å…·
- `git`
- `make gcc g++ unzip bc flex bison zip curl` ç­‰å¸¸è§ä¾èµ–
   ï¼ˆLOS Wiki ä¸Šæœ‰å®Œæ•´ä¾èµ–è¡¨ï¼‰

> âš ï¸ å»ºè®®ç£ç›˜ç©ºé—´è‡³å°‘ **200GB**ï¼Œå†…å­˜ 16GB+ï¼Œå¦åˆ™ç¼–è¯‘ä¼šå¾ˆç—›è‹¦ã€‚

------

### 2. è·å–æºç 

1. åˆå§‹åŒ– AOSP/LOS ä»“åº“ï¼š

   ```
   mkdir -p ~/android/lineage
   cd ~/android/lineage
   repo init -u https://github.com/LineageOS/android.git -b lineage-22.2 --git-lfs
   repo sync
   ```

è·å– **å°ç±³ 11 è®¾å¤‡æ ‘ã€å†…æ ¸ã€vendor blobs**ï¼š

- è®¾å¤‡æ ‘ï¼ˆdevice/xiaomi/venusï¼‰
- å†…æ ¸ï¼ˆkernel/xiaomi/sm8350ï¼‰
- vendorï¼ˆäºŒè¿›åˆ¶é©±åŠ¨ï¼Œé€šå¸¸åœ¨ [TheMuppets](https://github.com/TheMuppets)

### 3. è®¾ç½®ç¯å¢ƒå˜é‡

è¿›å…¥æºç ç›®å½•åï¼š

```
cd ~/android/lineage
. build/envsetup.sh
# è¿™é‡Œä¼šä¸‹è½½kernalå’Œdevice
breakfast venus
# éœ€è¦å†å‡†å¤‡vendor

# è¿™ä¸ªç”¨ä¸äº†
lunch lineage_venus-userdebug

croot
brunch venus
```

### 4. ç¼–è¯‘ ROM

```
mka bacon
```

### 5. åˆ·æœºæµ‹è¯•

ç”¨ adb sideload æˆ– TWRP/OrangeFox Recovery åˆ·å…¥ã€‚
æ³¨æ„ï¼šç¬¬ä¸€æ¬¡åˆ·è¦æ¸…é™¤ dataï¼Œå¦åˆ™ä¼šæ— é™å¾ªç¯ã€‚

ğŸ“Œ å…³äºã€Œäººè„¸è¯†åˆ«ã€çš„é—®é¢˜

LOS ç³»ç»Ÿé»˜è®¤æ˜¯ä¸æ”¯æŒé«˜é€šçš„ä¸“ç”¨äººè„¸è¯†åˆ«çš„ï¼Œå› ä¸ºï¼š

é«˜é€šçš„äººè„¸è¯†åˆ«ç”¨åˆ° é—­æº HAL (hardware abstraction layer)ã€‚

å®˜æ–¹ LOS åªä¿ç•™äº† AOSP çš„ã€Œä¿¡ä»»äººè„¸è§£é”ã€ï¼ˆ2D ç›¸æœºè¯†åˆ«ï¼‰ï¼Œå®‰å…¨æ€§å·®ã€‚

å¦‚æœä½ æƒ³è¦ åŸå‚çš„äººè„¸è¯†åˆ«ï¼š

å¿…é¡»æŠŠ MIUI çš„ç›¸å…³ HAL å’Œ framework è¡¥ä¸ä¸€èµ·ç§»æ¤è¿‡æ¥ã€‚

æœ‰çš„ ROMï¼ˆæ¯”å¦‚ miui.eu ä¿®æ”¹ç‰ˆï¼‰å°±æ˜¯é€šè¿‡ç§»æ¤æ¥å®ç°çš„ã€‚

è¿™æ„å‘³ç€ä½ éœ€è¦ï¼š

æŠŠ MIUI çš„ vendor é‡Œè·Ÿ faceunlock ç›¸å…³çš„ blobs æ‹·è¿‡æ¥ã€‚

ä¿®æ”¹ framework/base å’Œ settings ç›¸å…³ä»£ç ï¼Œè®©å®ƒä»¬è°ƒç”¨ HALã€‚
è¿™éƒ¨åˆ†æ¯”è¾ƒéš¾ï¼Œé€šå¸¸è¦çœ‹åˆ«çš„ ROM ä½œè€…çš„ patchã€‚



## ç¯å¢ƒå‡†å¤‡

### è®¾ç½®ä»£ç†ï¼ˆå¯é€‰ï¼‰

> åŠ é€Ÿä¸‹è½½ï¼Œipéœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹

```
export http_proxy="http://192.168.54.64:7890"
export https_proxy="http://192.168.54.64:7890"
```

### jdk

```
sudo apt install openjdk-21-jdk
java --version
```

### pythonç¯å¢ƒ

**LineageOS 17.1 åŠä»¥ä¸Š** â†’ Python 3

```
sudo apt install python3 python3-venv python3-pip python-is-python3
sudo apt install python-is-python3
python -V
```

### repo

`repo` æ˜¯ **Google ä¸“é—¨å†™çš„ä¸€ä¸ª Python å·¥å…·**ï¼Œç”¨æ¥ç®¡ç†è¶…å¤§è§„æ¨¡çš„ Git ä»“åº“ã€‚

å› ä¸º Android ç³»ç»Ÿçš„æºç ä¸æ˜¯åœ¨ä¸€ä¸ª Git ä»“åº“é‡Œï¼Œè€Œæ˜¯åˆ†æ•£åœ¨ä¸Šåƒä¸ªä»“åº“ï¼ˆAOSP + å„ç§å­é¡¹ç›®ï¼‰ï¼Œå¦‚æœä¸€ä¸ªä¸ª `git clone` ä¼šéå¸¸éº»çƒ¦ã€‚
 æ‰€ä»¥ Google æä¾›äº† `repo`ï¼Œå®ƒèƒ½ç”¨ä¸€ä¸ª **manifest æ–‡ä»¶ï¼ˆæ¸…å• XMLï¼‰** æ¥ç®¡ç†å’ŒåŒæ­¥æ‰€æœ‰å­ä»“åº“ã€‚

------

ğŸ“Œ ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆ

- `git` â†’ è´Ÿè´£å•ä¸ªä»“åº“
- `repo` â†’ ç”¨æ¥åŒæ—¶ç®¡ç†å‡ ç™¾ä¸Šåƒä¸ª `git` ä»“åº“

**å®‰è£… repo**

```
mkdir -p ~/bin
curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
chmod a+x ~/bin/repo
```

æŠŠ~/binæ”¾å…¥æ‰§è¡Œè·¯å¾„

~/.profile

```
# set PATH so it includes user's private bin if it exists
if [ -d "$HOME/bin" ] ; then
    PATH="$HOME/bin:$PATH"
fi
```

ç„¶åï¼Œè¿è¡Œ `source ~/.profile` æ¥æ›´æ–°æ‚¨çš„ç¯å¢ƒã€‚


`repo` å°±æ˜¯ Android ROM å¼€å‘çš„ã€Œè¶…çº§ Git ç®¡ç†å™¨ã€ï¼Œæ²¡æœ‰å®ƒå‡ ä¹æ²¡æ³•æ–¹ä¾¿åœ°æ‹‰å–å’Œç®¡ç†æ•´ä¸ª AOSP/LOS æºç ã€‚


### git make gcc g++ unzip bc flex bison zip curlç­‰å¸¸è§ä¾èµ–

```
sudo apt update
sudo apt install -y \
bc bison build-essential ccache curl flex g++-multilib gcc-multilib git git-lfs gnupg gperf imagemagick \
protobuf-compiler python3-protobuf lib32z1 lib32ncurses-dev libdw-dev libelf-dev lz4 libsdl1.2-dev \
libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev
```

Debian ç‰¹æœ‰è¯´æ˜

- Debian 13 é»˜è®¤å·²ç»æ”¯æŒ `multiarch`ï¼Œç¡®ä¿ i386 æ¶æ„å¯ç”¨ï¼š

```
sudo dpkg --add-architecture i386
sudo apt update
```

ç„¶åå®‰è£… 32 ä½ä¾èµ–ï¼š

```
sudo apt install lib32z1 lib32ncurses-dev lib32readline-dev
```

**é…ç½® git**

é‰´äº `repo` è¦æ±‚æ‚¨è¯†åˆ«è‡ªå·±çš„èº«ä»½æ‰èƒ½åŒæ­¥ Androidï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥é…ç½®æ‚¨çš„ `git` èº«ä»½ï¼š

```
git config --global user.email "zjw@gmail.com"
git config --global user.name "zjw"
```

ç”±äºè§„æ¨¡è¾ƒå¤§ï¼ŒæŸäº›ä»“åº“é…ç½®ä¸º [`lfs` ï¼ˆ `Large File Storage`](https://git-lfs.com/) ã€‚ä¸ºç¡®ä¿ä½ çš„å‘è¡Œç‰ˆå·²ä¸ºæ­¤åšå¥½å‡†å¤‡ï¼Œè¯·è¿è¡Œï¼š

```
git lfs install
```

ä¸ºäº†é¿å…æäº¤æ¶ˆæ¯ä¸­å‡ºç°é‡å¤çš„ `Change-Id:` å°¾éƒ¨ï¼Œå°¤å…¶æ˜¯åœ¨æŒ‘é€‰æ›´æ”¹æ—¶ï¼Œè¯·å°† `Change-Id:` è®¾ä¸º git å·²çŸ¥çš„å°¾éƒ¨ï¼š

```
git config --global trailer.changeid.key "Change-Id"
```

æŸ¥çœ‹gitå…¨å±€é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼š

```
git config --global --list
```

### å¼€å¯ç¼“å­˜ä»¥åŠ é€Ÿæ„å»º

å¦‚æœæ‚¨æƒ³é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åŠ é€Ÿåç»­æ„å»ºï¼Œè¯·ä½¿ç”¨ [`ccache`](https://ccache.samba.org/) ï¼š

```
export USE_CCACHE=1
export CCACHE_EXEC=/usr/bin/ccache
```

å¹¶å°†è¯¥è¡Œæ·»åŠ åˆ°ä½ çš„ `~/.bashrc` æ–‡ä»¶ä¸­ã€‚ç„¶åï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤æŒ‡å®š `ccache` ä½¿ç”¨çš„æœ€å¤§ç£ç›˜ç©ºé—´ï¼š

```
ccache -M 50G
```

## éœ€è¦çš„ä¸‰ä»¶å¥—

### **Device Tree**

- æè¿°è®¾å¤‡çš„ç¡¬ä»¶ä¿¡æ¯ï¼ˆåˆ†åŒºè¡¨ã€å±å¹•åˆ†è¾¨ç‡ã€æŒ‰é”®å¸ƒå±€ã€å¼€æœº init è„šæœ¬â€¦ï¼‰ã€‚
- ä½ç½®ï¼š`device/<vendor>/<device>/`
- æ²¡å®ƒï¼Œç¼–è¯‘ç³»ç»Ÿä¸çŸ¥é“è¦ä¸ºå“ªå°è®¾å¤‡ç”Ÿæˆé•œåƒã€‚

```
git clone -b 15.0 https://github.com/crdroidandroid/android_device_xiaomi_venus.git venus
git clone https://github.com/LineageOS/android_device_xiaomi_sm8350-common sm8350-common

```

ä¿®æ”¹venusé‡Œé¢çš„extract-files.shé‡Œé¢çš„ä¸º`python extract-files.py`

adbè¿æ¥åä½¿ç”¨extract-files.shæå–vendor blobs

### **Kernel Source**

- å¯¹åº”ä½ æ‰‹æœºå†…æ ¸ç‰ˆæœ¬çš„æºç ã€‚

å°ç±³ 11 (venus) å†…æ ¸æºç å¯ä»¥ä»å®˜æ–¹å¼€æºä»“åº“ä¸‹è½½

```
cd ~/android/lineage/kernel/xiaomi
git clone -b lineage-22.2 https://github.com/LineageOS/android_kernel_xiaomi_sm8350.git venus
```

### **Vendor Blobs**

- å‚å•†é—­æºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆGPU é©±åŠ¨ã€ç›¸æœº HALã€éŸ³é¢‘ç¼–è§£ç å™¨ç­‰ï¼‰ã€‚
- ä½ç½®ï¼š`vendor/<vendor>/<device>/`
- æ²¡å®ƒï¼Œç¼–è¯‘å‡ºæ¥çš„ç³»ç»Ÿå³ä½¿èƒ½å¯åŠ¨ï¼Œç¡¬ä»¶åŠŸèƒ½ä¹Ÿå‡ ä¹å…¨æ®‹ï¼ˆæ²¡ WiFiã€æ²¡ç›¸æœºï¼‰ã€‚

ä¸‹è½½çº¿åˆ·åŒ…ï¼Œè§£å‹ï¼š

```
tar -zxvf venus_images_OS2.0.2.0.UKBCNXM_20250312.0000.00_14.0_cn_42488fed63.tgz
mkdir ~/venus_extracted
cp ~/venus_images_OS2.0.2.0.UKBCNXM_14.0/images/super.img ~/venus_extracted
```

```
cd ~
git clone https://github.com/unix3dgforce/lpunpack.git
cd lpunpack
python3 ~/lpunpack/lpunpack.py ~/venus_extracted/super.img ~/venus_extracted/output_dir
```

æ¥ä¸‹æ¥æŒ‚è½½ vendor_a.img å¹¶å¤åˆ¶åˆ°æºç ç›®å½•

```
mkdir ~/vendor_mount
sudo mount -o loop ~/venus_extracted/output_dir/vendor_a.img ~/vendor_mount
mkdir -p ~/android/lineage/vendor/xiaomi/venus
sudo cp -r ~/vendor_mount/* ~/android/lineage/vendor/xiaomi/venus/
sudo chown -R zjw:zjw ~/android/lineage/vendor/xiaomi/venus/
sudo umount ~/vendor_mount
rmdir ~/vendor_mount
```

æœ€åä¸‹è½½çš„è¿™ä¸ª

```
https://github.com/TheMuppets/proprietary_vendor_xiaomi_sm8350-common
```





https://github.com/LineageOS/android

https://github.com/crdroidandroid/android_kernel_xiaomi_venus

https://github.com/PixelExperience-Devices/kernel_xiaomi_venus

è®¾å¤‡æ ‘

https://github.com/Evolution-XYZ-Devices/device_xiaomi_venus
